# Kitty Graphics Protocol - Benchmark 测试报告

## 测试环境

- **测试日期**: 2026-02-28
- **Rust Edition**: 2024
- **测试工具**: Criterion 0.5.1
- **样本数量**: 100 samples per benchmark
- **测量时间**: 5 seconds per benchmark

---

## 1. 命令构建 (Command Builder)

测试命令构建器的性能。

| 测试项 | 执行时间 | 备注 |
|--------|----------|------|
| basic_transmit | 7.86 ns | 基础传输命令构建 |
| complex_command | 8.09 ns | 复杂命令（多字段） |
| animation_frame | 7.68 ns | 动画帧命令 |
| delete_command | 7.69 ns | 删除命令 |

**结论**: 命令构建极快，约 8 纳秒/操作，性能开销可忽略不计。

---

## 2. 序列化性能 - 小数据

| 测试项 | 数据大小 | 执行时间 | 吞吐量 |
|--------|----------|----------|--------|
| png_1kb | 1 KB | 754 ns | 1.26 GiB/s |
| rgba_100x100 | 40 KB | 17.0 µs | 2.18 GiB/s |

---

## 3. 序列化性能 - 中等数据

| 测试项 | 数据大小 | 执行时间 | 吞吐量 |
|--------|----------|----------|--------|
| png_50kb | 50 KB | 21.6 µs | 2.21 GiB/s |
| rgba_256x256 | 256 KB | 111 µs | 2.20 GiB/s |

---

## 4. 序列化性能 - 大数据

| 测试项 | 数据大小 | 执行时间 | 吞吐量 |
|--------|----------|----------|--------|
| png_500kb | 500 KB | 489 µs | 998 MiB/s |
| rgba_512x512 | 1 MB | 1.06 ms | 944 MiB/s |

**注意**: 大数据序列化吞吐量略有下降，但仍保持在 ~1 GiB/s 的水平。

---

## 5. 分块序列化 (Chunked Serialization)

测试分块传输功能，用于大数据传输。

| 数据大小 | 执行时间 | 吞吐量 | 分块数 |
|----------|----------|--------|--------|
| 4 KB | 2.19 µs | 1.74 GiB/s | 1 |
| 16 KB | 7.97 µs | 1.91 GiB/s | 4 |
| 64 KB | 31.0 µs | 1.97 GiB/s | 14 |
| 256 KB | 128 µs | 1.90 GiB/s | 55 |
| 1 MB | 539 µs | 1.81 GiB/s | 218 |

**结论**: 分块序列化性能稳定，吞吐量保持在 1.8-2.0 GiB/s 之间。

---

## 6. 分块迭代 (Chunked Iteration)

| 测试项 | 执行时间 | 吞吐量 |
|--------|----------|--------|
| iterate_chunks_100kb | 46.9 µs | 2.03 GiB/s |

---

## 7. 响应解析 (Response Parsing)

测试终端响应解析性能。

| 测试项 | 执行时间 | 备注 |
|--------|----------|------|
| parse_ok | 47.6 ns | 解析简单 OK 响应 |
| parse_ok_placement | 76.8 ns | 解析带 placement ID 的响应 |
| parse_ok_number | 77.2 ns | 解析带 image number 的响应 |
| parse_error | 117 ns | 解析错误响应 |

**结论**: 响应解析极快，所有场景均在 120 纳秒内完成。

---

## 8. 便捷函数 (Convenience Functions)

高级 API 性能测试。

| 测试项 | 数据大小 | 执行时间 | 吞吐量 |
|--------|----------|----------|--------|
| transmit_png_50kb | 50 KB | 24.2 µs | 1.97 GiB/s |
| transmit_rgba_256x256 | 256 KB | 123 µs | 1.99 GiB/s |
| transmit_rgb_256x256 | 192 KB | 100 µs | 1.83 GiB/s |

---

## 9. 控制数据构建 (Control Data)

测试控制数据字符串构建性能。

| 测试项 | 执行时间 | 备注 |
|--------|----------|------|
| simple_control_data | 183 ns | 简单命令 |
| complex_control_data | 1.21 µs | 多字段命令 |

---

## 10. Base64 编码 (参考基准)

作为参考，测试底层 base64 编码性能。

| 数据大小 | 执行时间 | 吞吐量 |
|----------|----------|--------|
| 1 KB | 397 ns | 2.40 GiB/s |
| 10 KB | 3.60 µs | 2.65 GiB/s |
| 100 KB | 37.3 µs | 2.56 GiB/s |
| 1 MB | 388 µs | 2.52 GiB/s |

---

## 性能总结

### 吞吐量对比

```
                    吞吐量 (GiB/s)
Base64 编码          ████████████████████████ 2.52
分块序列化 (64KB)    ████████████████████ 1.97
便捷函数             ████████████████████ 1.99
序列化 (小数据)      ████████████████████ 2.18
序列化 (大数据)      █████████████ 1.00
```

### 关键发现

1. **命令构建**: 极快 (~8 ns)，几乎无开销
2. **序列化吞吐量**: 稳定在 1.8-2.2 GiB/s
3. **响应解析**: 极快 (<120 ns)
4. **Base64 编码**: 是主要性能瓶颈，约占总时间的 70-80%

### 性能建议

1. **大图像优化**: 对于 >500KB 的图像，考虑使用压缩 (o=z)
2. **批量传输**: 使用分块传输可避免内存峰值
3. **文件传输**: 对于本地文件，使用 `t=f` 传输模式可跳过 base64 编码

---

## 测试命令

```bash
# 运行所有 benchmark
cargo bench

# 运行特定 benchmark
cargo bench -- serialize

# 生成 HTML 报告
cargo bench -- --save-baseline main
```

HTML 报告位于: `target/criterion/`
